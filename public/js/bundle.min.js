(function(){
'use strict';var Client={};
(function(){Client.connectToServer=function(){Client.socket=io.connect();Client.socket.on("playerUpdate",function(a){gameplayState.movePlayer(a.id,a.x,a.y,a.d)});Client.socket.on("playerEvent",function(a){a.disconnectTime?gameplayState.removePlayer(a.playerId):gameplayState.addNewPlayer(a.playerId,a.x,a.y)});Client.socket.on("initWorld",function(a){console.log(a);for(var b=a.players,c=0;c<b.length;c++)gameplayState.addNewPlayer(b[c].id,b[c].x,b[c].y);a.id&&gameplayState.setPlayerReference(a.id);gameplayState.generateTiles(a.tiles)});
Client.socket.on("worldUpdate",function(a){for(var b=0;b<a.tiles.length;b++){var c=a.tiles[b];gameplayState.changeTileAt(c[0],c[1],c[2])}});Client.socket.on("playSound",function(a){gameplayState.playAbstractSoundAt(a.x,a.y)})};Client.disconnectFromServer=function(){Client.socket.disconnect()};Client.askNewPlayer=function(){Client.socket.emit("newplayer");console.log("newPlayer")};Client.sendMove=function(a){Client.socket.emit("inputCommand",{type:1,params:a})};Client.changeTile=function(a,b){Client.socket.emit("inputCommand",
{type:2,params:{tileId:a}})};Client.playSound=function(){Client.socket.emit("inputCommand",{type:3})}})();var GameplayState=function(a){this.playerMap={};this.player=null;this.textStyle={font:"20px Arial",fill:"#FFF"}},playerSpeed=32,tileName=["Grass","Sand","Stone"],FACING_LEFT=4,FACING_UP=8,FACING_DOWN=2,FACING_RIGHT=6,MIN_HEARING_DISTANCE=600,TILE_SIZE=32;
GameplayState.prototype={init:function(){Client.connectToServer()},preload:function(){},create:function(){this.createSoundObjects();game.world.setBounds(0,0,64*TILE_SIZE,64*TILE_SIZE);this.tileGroup=game.add.group();this.tileMap=game.add.tilemap();this.tileMap.setTileSize(TILE_SIZE,TILE_SIZE);this.tileMap.addTilesetImage("gameTileset");this.mainLayer=this.tileMap.create("mainLayer",64,64,TILE_SIZE,TILE_SIZE);this.tileChoice=0;this.tileText=game.add.text(32,32,tileName[this.tileChoice],this.textStyle);
this.tileText.fixedToCamera=!0;game.input.keyboard.onDownCallback=this.handleKeys},shutdown:function(){Client.disconnectFromServer()},update:function(){},createSoundObjects:function(){this.placeTileSound=game.add.audio("placeTileSound");this.abstractChirpSound=game.add.audio("abstractChirpSound")},addNewPlayer:function(a,b,c){this.playerMap[a]=new Player(game,b*TILE_SIZE,c*TILE_SIZE,"player");game.add.existing(this.playerMap[a])},setPlayerReference:function(a){this.player=this.playerMap[a];game.camera.follow(this.player,
Phaser.Camera.FOLLOW_TOPDOWN)},removePlayer:function(a){this.playerMap[a].destroy();delete this.playerMap[a]},handleKeys:function(a){a.keyCode==Phaser.Keyboard.UP&&Client.sendMove(8);a.keyCode==Phaser.Keyboard.DOWN&&Client.sendMove(2);a.keyCode==Phaser.Keyboard.LEFT&&Client.sendMove(4);a.keyCode==Phaser.Keyboard.RIGHT&&Client.sendMove(6);a.keyCode==Phaser.Keyboard.ONE&&(this.tileChoice=0,gameplayState.tileText.text=tileName[this.tileChoice]);a.keyCode==Phaser.Keyboard.TWO&&(this.tileChoice=1,gameplayState.tileText.text=
tileName[this.tileChoice]);a.keyCode==Phaser.Keyboard.THREE&&(this.tileChoice=2,gameplayState.tileText.text=tileName[this.tileChoice]);a.keyCode==Phaser.Keyboard.SPACEBAR&&Client.changeTile(this.tileChoice,gameplayState.player.facing);a.keyCode==Phaser.Keyboard.E&&Client.playSound();a.keyCode==Phaser.Keyboard.ESC&&game.state.start("MainMenuState")},playAbstractSoundAt:function(a,b){this.playSoundFrom(this.abstractChirpSound,a,b)},movePlayer:function(a,b,c,d){this.playerMap[a].setDirection(d);this.playerMap[a].ableToMove()&&
this.playerMap[a].moveTo(b*TILE_SIZE,c*TILE_SIZE)},changeTileAt:function(a,b,c){0>a||a>=this.tileMap.width||0>b||b>=this.tileMap.height?console.log("invalid tile position"):(this.playSoundFrom(this.placeTileSound,a*TILE_SIZE,b*TILE_SIZE),this.tileMap.putTile(c,a,b))},generateTiles:function(a){for(var b=0;b<a.length;b++)for(var c=0;c<a[b].length;c++)this.tileMap.putTile(a[b][c],b,c)},playSoundFrom:function(a,b,c){b=this.getDistance(b,c,this.player.x,this.player.y)/MIN_HEARING_DISTANCE;1<b&&(b=1);a.volume=
1-b;0<a.volume&&a.play()},getDistance:function(a,b,c,d){return Math.sqrt((c-a)*(c-a)+(d-b)*(d-b))}};var GAME_WIDTH=640,GAME_HEIGHT=480,game,mainMenuState,gameplayState;window.onload=function(){game=new Phaser.Game(GAME_WIDTH,GAME_HEIGHT,Phaser.AUTO);mainMenuState=new MainMenuState(game);gameplayState=new GameplayState(game);game.state.add("MainMenuState",mainMenuState);game.state.add("GameplayState",gameplayState);game.state.start("MainMenuState")};var MainMenuState=function(a){this.textStyle={font:"32px Arial",fill:"#FFF"}};
MainMenuState.prototype={init:function(){game.stage.disableVisibilityChange=!0;game.stage.smoothed=!1;this.titleText=game.add.text(GAME_WIDTH/2,180,"Alterrain",this.textStyle);this.titleText.anchor.setTo(.5);this.promptText=game.add.text(GAME_WIDTH/2,300,"Press Enter to Join",this.textStyle);this.promptText.anchor.setTo(.5)},preload:function(){game.load.spritesheet("player","./assets/img/person_spritesheet_large.png",32,32);game.load.image("gameTileset","./assets/img/game_tileset.png",32,32);game.load.audio("placeTileSound",
"assets/audio/place_tile.ogg");game.load.audio("abstractChirpSound","assets/audio/abstract_chirp01.ogg")},create:function(){game.stage.backgroundColor="#222";game.scale.pageAlignHorizontally=!0},update:function(){game.input.keyboard.justPressed(Phaser.Keyboard.ENTER)&&game.state.start("GameplayState")}};function Player(a,b,c,d,e){Phaser.Sprite.call(this,a,b,c,d,e);this.canMove=!0;this.moveDuration=100;this.nextPos={x:0,y:0};this.moveTimer=a.time.create(!1);this.moveTimer.loop(this.moveDuration,this.stepTo,this);this.facing=FACING_DOWN}Player.prototype=Object.create(Phaser.Sprite.prototype);Player.prototype.constructor=Player;Player.prototype.update=function(){this.canMove||this.stepTo()};Player.prototype.ableToMove=function(){return this.canMove};
Player.prototype.stepTo=function(){console.log("Stepped");this.x<this.nextPos.x?this.x++:this.x>this.nextPos.x?this.x--:this.y<this.nextPos.y?this.y++:this.y>this.nextPos.y&&this.y--;this.nextPos.x===this.x&&this.nextPos.y===this.y&&(this.canMove=!0)};Player.prototype.setDirection=function(a){this.facing=a;switch(a){case FACING_DOWN:this.frame=0;break;case FACING_LEFT:this.frame=3;break;case FACING_RIGHT:this.frame=1;break;case FACING_UP:this.frame=2}};
Player.prototype.moveTo=function(a,b){this.canMove&&(this.canMove=!1,this.nextPos={x:a,y:b},this.x<this.nextPos.x?(this.facing=FACING_RIGHT,this.frame=1):this.x>this.nextPos.x?(this.facing=FACING_LEFT,this.frame=3):this.y<this.nextPos.y?(this.facing=FACING_DOWN,this.frame=0):this.y>this.nextPos.y&&(this.facing=FACING_UP,this.frame=2),this.x=a,this.y=b,this.canMove=!0)};
}).call(this)
